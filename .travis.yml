# We will use docker to set up out environment, so don't use any particular
# language in Travis itself
language: generic

# Enable docker
sudo: required
services:
    - docker

# Disable automatic submodule fetching (it's done recursively)
git:
    submodules: false

# Do a shallow submodule fetch
before_install: git submodule update --init

env:
    global:
        # Make sure beaver is in the PATH
        - PATH="$(git config -f .gitmodules submodule.beaver.path)/bin:$PATH"
    matrix:
        - DMD=1.080.0 DIST=trusty F=production
        - DMD=1.080.0 DIST=trusty F=devel
        - DMD=1.080.0 DIST=xenial F=production AFTER_SCRIPT=1
        - DMD=1.080.0 DIST=xenial F=devel
        - DMD=2.070.2.s12 DIST=trusty F=production
        - DMD=2.070.2.s12 DIST=trusty F=devel
        - DMD=2.070.2.s12 DIST=xenial F=production
        - DMD=2.070.2.s12 DIST=xenial F=devel

install:
    - beaver docker build --build-arg "DMD=$DMD" --build-arg "DC=$(ci/DC.sh)" -f "Dockerfile${DIST:+.$DIST}" .

script:
    - beaver run ci/test.sh

after_success:
    # run only once among matrix rows, workaround for Travis lack of support
    # for sequential pipelines
    - test "$AFTER_SCRIPT" || exit 0
    - beaver run ci/codecov.sh
    - beaver run ci/d2-convert-tag.sh
